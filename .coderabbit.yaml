# yaml-language-server: $schema=https://storage.googleapis.com/coderabbit_public_assets/schema.v2.json

language: en-US
early_access: false
enable_free_tier: true

reviews:
  # Tone & automation
  profile: assertive
  auto_review:
    base_branches:
      - 'dev'
      - 'master'
    enabled: true
    drafts: false

  # Reviewers & labels
  suggested_reviewers: true
  auto_assign_reviewers: true
  suggested_labels: true
  auto_apply_labels: true

  # Status handling
  fail_commit_status: true

  # Additional review features
  high_level_summary: true
  changed_files_summary: true
  sequence_diagrams: true

  # Focus CR on the meaningful parts of the repo
  path_filters:
    - 'src/**'
    - 'prisma/**'
    - 'docker/**'
    - 'scripts/**'
    - 'docs/**'
    - 'README.md'
    - '!public/assets/**'
    - '!.next/**'
    - '!**/*.tsbuildinfo'

  # Apply house rules per area
  path_instructions:
    - path: 'src/app/[(]server[)]/api/**/route.ts'
      instructions: >
        Keep route handlers thin: validate with Zod (shared schemas), call a Service,
        then return a typed response. Do NOT import prisma/redis or perform business logic here.
        Example: parse with a schema from src/lib/validation/** and call a function in
        src/app/(server)/services/** that returns typed data.
    - path: 'src/app/[(]server[)]/services/**'
      instructions: >
        All business logic lives here. No Request/Response/cookies; accept plain inputs
        and return typed results. Reuse shared types and Zod schemas from src/lib/validation/**.
        Keep services framework-agnostic and unit-testable.
    - path: 'src/lib/validation/**'
      instructions: >
        Define Zod schemas and infer types via z.infer. Avoid duplicate shapes; export
        schemas for reuse in Services and API routes. Co-locate schema files by domain.
    - path: 'src/app/[(]client[)]/**'
      instructions: >
        Use TanStack Query hooks for server data (no inline fetches in components).
        Import query keys from src/lib/queryKeys.ts (canonical). Keep components presentational;
        Tailwind-first styling. Example: import { keys } from 'src/lib/queryKeys' and call
        a typed hook rather than fetch in the component.
    - path: 'src/shadcn-ui/**'
      instructions: >
        Generated shadcn primitives. Do not modify these files. Create wrapper or
        derivative components under src/app/(client)/components/** and compose from
        the shadcn primitives instead.
    - path: 'prisma/**'
      instructions: >
        If schema changes, include proper Prisma migration(s) and update seed/types.
        Avoid schema edits without migrations.
    - path: 'src/db/prisma.ts'
      instructions: >
        Prisma client must be a singleton and server-only. Do not import in client code.
    - path: 'scripts/**'
      instructions: >
        Tooling only (env/db/ops). No app business logic.
    - path: 'src/lib/queryKeys.ts'
      instructions: >
        Canonical source for TanStack Query keys. Add new keys here and import
        from this module across the client instead of ad-hoc arrays.
    - path: 'docker/**'
      instructions: >
        Ensure env parity with env/.env.example. Prefer minimal, portable changes.
    - path: 'docs/**'
      instructions: >
        Keep Development Guide aligned with current directory structure and conventions.
        Update docs when APIs/routes/schemas change.
    - path: 'src/middleware.ts'
      instructions: >
        Global middleware for auth/guards/request shaping only. No business logic.
    - path: 'src/lib/middleware/**'
      instructions: >
        Shared middleware helpers. Keep lean; no business logic or side effects.

  # Teach CR how to label PRs for this repo (array of objects)
  labeling_instructions:
    - {
        label: 'ğŸ›  Backend',
        instructions: 'Apply to changes under src/app/(server)/**, src/db/**, or prisma/**.',
      }
    - {
        label: 'ğŸ¨ Frontend',
        instructions: 'Apply to changes under src/app/(client)/** or src/shadcn-ui/**.',
      }
    - {
        label: 'ğŸ“– Documentation',
        instructions: 'Apply to changes under docs/**, README.md, CONTRIBUTING.md, SECURITY.md.',
      }
    - {
        label: 'ğŸ”§ Refactor',
        instructions: 'Apply to structural moves/renames or cleanup without API/route contract changes.',
      }
    - {
        label: 'ğŸ› Bug',
        instructions: "Apply to fixes for regressions, runtime errors, or failing paths (e.g., commit starts with 'fix:').",
      }
    - {
        label: 'âœ¨ New Feature',
        instructions: 'Apply to new API routes/services, new UI pages/components, or new capabilities.',
      }
    - {
        label: 'ğŸ§¹ Cleanup',
        instructions: 'Apply to dead code removal, lint fixes, or directory tidying.',
      }
    - {
        label: 'ğŸ–Œï¸ UX/UI Change',
        instructions: 'Apply to layout/CSS/prop changes purely for UI/UX.',
      }
    - {
        label: 'ğŸ§© Core',
        instructions: 'Apply to proxy/chat/auth/llmConfig or other critical modules.',
      }
    - {
        label: 'âœ… Testing',
        instructions: 'Apply to additions or updates to tests/test scaffolding.',
      }

  tools:
    eslint:
      enabled: true
    yamllint:
      enabled: true
    hadolint:
      enabled: true
    gitleaks:
      enabled: true

knowledge_base:
  code_guidelines:
    enabled: true
    filePatterns:
      - 'README.md'
      - 'docs/architecture.md'
      - 'docs/getting-started.md'
      - 'docs/development-guide.md'
  web_search:
    enabled: true
