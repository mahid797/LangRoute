# Development Guide

## Purpose & Scope

This guide outlines development conventions, coding standards, and architectural patterns for the LangRoute codebase. It serves as the source of truth for how we write, organize, and maintain code across the project. Use this guide to ensure consistency, maintainability, and clarity in all contributions.

## Directory & Path Rules

The following structure reflects the current `dev` branch organization exactly:

- **API routes**: `src/app/(server)/api/**/route.ts`  
  No `_api` prefix or `/v1` versioning. A single `/v1/*` route may exist in the future only for OpenAI compatibility—do not version other routes.

- **Services** (all business logic): `src/app/(server)/services/**`  
  Pure business logic that can be called from API routes or background jobs.

- **Validation** (Zod + `z.infer`): `src/lib/validation/**`  
  Shared validation schemas used across client and server.

- **Prisma client**: `src/db/prisma.ts`  
  Singleton client for server-only database access.

- **Query keys** (for TanStack Query): Create `src/lib/queryKeys.ts` if needed  
  Canonical query key patterns for consistent caching.

- **Middleware**: `src/middleware.ts` and helpers in `src/lib/middleware/**`  
  Authentication, guards, and request shaping only.

- **Error mapping**: `src/app/(server)/services/system/errorService.ts`  
  Centralized error handling and response formatting.

- **Utilities**: `src/lib/utils/**`  
  `cn()` function in `classnames.ts`; re-export via `index.ts` so `@lib/utils` works.

- **shadcn primitives** (generated, treat as vendor): `src/shadcn-ui/**`  
  **Do not modify these files**.

- **Components/wrappers**: `src/app/(client)/components/**`  
  Custom components and shadcn wrappers.

## Coding Standards

- **TypeScript strict**: Avoid `any`/non-null assertions unless justified (e.g., Zod parsing edge cases)
- **Meaningful names**: Use descriptive, full words; avoid abbreviations
- **Small, focused files**: Keep files under 200 lines when possible
- **Reuse before re-implementing**: Check existing utilities, hooks, and components first
- **Import aliases**: Prefer `@services`, `@lib`, `@hooks`, etc. over relative paths
- **Comments for non-trivial logic**: JSDoc for complex services; inline comments sparingly
- **Structure logic before styling**: Focus on functionality first, styling second

## API Route Pattern

All API routes follow this consistent pattern:

1. Zod validate (`body`, `params`, `searchParams`)
2. Call Service function with validated data
3. Return `Response.json(data)` with appropriate status

**Example:**
```ts
import { z } from 'zod';
import { createKey } from '@services/apiKey/service';
import { CreateApiKeySchema } from '@lib/validation/apiKey.schemas';

export async function POST(req: Request) {
  const body = await req.json();
  const input = CreateApiKeySchema.parse(body);
  const key = await createKey(input);
  return Response.json(key, { status: 201 });
}
```

## Services Pattern

Services contain pure business logic with these characteristics:

- **No framework globals**: No access to `Request`/`Response`/cookies
- **Typed inputs/outputs**: Accept data parameters, return typed results
- **Reusable**: Callable from API handlers, background jobs, and other services
- **Error handling**: Throw `ServiceError` for expected failures; leverage `errorService` for consistent error mapping
- **Domain separation**: Split large services by feature area

## Frontend Rules

- **No fetch in components**: Use TanStack Query hooks exclusively
- **Query keys**: Import consistent keys from `src/lib/queryKeys.ts` (if/when created)
- **Tailwind-first styling**: Compose from shadcn **wrappers**, not by editing `src/shadcn-ui/**`
- **Conditional styling**: Use `cn()` helper from `@lib/utils` for dynamic classes
- **Error boundaries**: Handle failures gracefully with user-friendly messages

## Validation Rules

- **Shared schemas**: Place reusable schemas in `src/lib/validation/**`
- **Type inference**: Use `z.infer<typeof schema>` instead of duplicating types
- **Import reuse**: Import shared schemas in API routes where applicable
- **Fail fast**: Validate input early and return 400 responses immediately on failure

## Middleware Rules

Keep middleware lean and focused:

- **Authentication/guards**: Session checks and role verification
- **Request shaping**: Input parsing and transformation
- **No business logic**: Delegate complex operations to services
- **Public routes**: Configure bypass patterns in `src/lib/middleware/publicRoutes.ts`

## Environment & Config

- **Environment variables**: If you add env vars, also update `env/.env.example`
- **Config YAML**: Planned feature for model/provider configuration—reference sample at `src/lib/config/sample-config-yaml-file-for-models`
- **Environment merging**: Generated by `scripts/prepare-env.mjs` during development
- **Never commit**: Actual `.env` files stay local; only track `.env.example`

## Docs Crosslinks

- [Architecture Overview](./architecture.md) - System design and component relationships
- [Getting Started](./getting-started.md) - Local development setup and common commands

## Scripts

Key development commands (reference only):

- `npm run dev:boot` - Complete setup: check, env, database, and dev server
- `npm run check` - TypeScript checking and linting
- `npm run db` - Database management commands
- `npm run env` - Environment file generation

> **Do not modify `src/shadcn-ui/**`.** Treat these as generated/vendor files. For changes, create wrapper/derivative components under `src/app/(client)/components/**` and compose from shadcn primitives.

---

*Last updated: 2025-01-25*